<html>
  <head>
    <link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />
	<script type="text/javascript" src="/js/jquery-1.4.3.min.js"></script>
	
	
	
	<script type='text/javascript'>
		var mplat = 61.2;
		var previous_data = {};
		var inactive_timer = 0;
		var timer_active = 0;
		var inactive_timeout;
		
		var timeout = 60;
		
		
		function timer(){
			if(timer_active){
				inactive_timer = inactive_timer+1;
				setTimeout(timer,1000);	
			}				
		}		
		
		var me = {
			changed: false,
			lat: {{ start_lat }},
			lon: {{ start_lon }},
			sess: "{{ session }}",
			move: function(heading){
				if(heading>0){
					this.lat += 0.00001;					
				}else{
					this.lat -= 0.00001;
				}
				this.changed = true;
				if(inactive_timer>timeout*1000){
					clearTimeout(inactive_timeout);
					server_update();
				}
			},
			strafe: function(direction){
				if(direction=="right"){
					alert("right");
				}else if(direction=="left"){
					alert("left");
				}
			}	
		}
		function server_update(){
			if(me.changed){
				timer_active = 0;
				inactive_timer = 0;
				me.changed = false;
				$.ajax({
					      url: "/update",
					      type: "POST",
					      data: ({ lat : me.lat, lon : me.lon, session : me.sess }),
					      dataType: "json",
					      success: function(data){
					      	alert(data.users[0].username);
							setTimeout(server_update,250);	
					      }
					   }
					)
			}else{
				if(timer_active==0){
					timer_active = 1;
					inactive_timer = 0;
					timer();
				}				
				$.ajax({
					      url: "/update",
					      type: "POST",
					      data: ({ session : me.sess }),
					      dataType: "json",
					      success: function(data){
					         if(inactive_timer>timeout*1000){
					         	inactive_timeout = setTimeout(server_update,1000);				         
					         }else{
					         	// If there are no users around, slow down the updates
					      	 	if(data.users.length<2){
					      	 		setTimeout(server_update,500);	
					      	 	}else{
					      	 		server_update();
					      	 	}
					         }
					      	 							 
					      }
					   }
					)
			}	
		}
		$(document).ready(function(){
			setTimeout(server_update,250);
			$(document).keydown(function(event){
				if(event.keyCode == '87' || event.keyCode =='38'){
					me.move(270);
				}else if(event.keyCode == '68' || event.keyCode =='39'){
					me.strafe("right");
				}else if(event.keyCode == '83' || event.keyCode =='40'){
					me.move(-270);
				}else if(event.keyCode == '65' || event.keyCode =='37'){
					me.strafe("left");
				}
			});					
		});	
	</script>
  </head>
  <body>
  </body>
</html>