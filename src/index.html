<!DOCTYPE html>

<html>

<head>
<link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />
<script type="text/javascript" src="/js/jquery-1.4.3.min.js">
        </script>
<script type="text/javascript"
	src="http://www.google.com/jsapi?key=ABQIAAAAIKQG3lTVGFS3EZyE-MLGaRREwtvvtNaMRh6XxsrEhNJYgMerAxS_tphRXpLQDpaaV0o2vOjhv15piA">
        </script>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false">
		</script>
        <script type='text/javascript'>
        	var map;
        	var marker
            var ge;
            var model;
            google.load("earth", "1");
            var mplat = 61.2;
            var previous_data = {};
            var inactive_timer = 0;
            var timer_active = 0;
            var inactive_timeout;
            var bRightKeyDown = false;
            var bLeftKeyDown = false;
            var bUpKeyDown = false;
            var bDownKeyDown = false;
            var bSpaceKeyDown = false;
            var animRunning = false;
            var timeout = 60;
            var ANIM_ALTITUDE = 5;
            var TURN_DEGREES = 2;
            var WALK_SPEED = 1;
            var TURBO_SPEED = 2;
            var GAS_COUNT = 0;

            function failureCallback(object) {}

            function timer() {
                if (timer_active) {
                    inactive_timer = inactive_timer + 1;
                    setTimeout(timer, 1000);
                }
            }
            
            function updateSpeed()
            {
            	if (bUpKeyDown || bDownKeyDown)
            	{
            		GAS_COUNT = GAS_COUNT + 1;
            	}
            	else
            		{
	            		GAS_COUNT = GAS_COUNT - 5;
            		}
            	
            	if (GAS_COUNT > 100)
        		{
            		GAS_COUNT = 100;
        		}
            	else if (GAS_COUNT < 0)
        		{
            		GAS_COUNT = 0;
        		}
            	
                 	           	
                WALK_SPEED = 1/100 * GAS_COUNT;
                 
                //$('#dvSpeed').html('Speed: ' +Math.round( GAS_COUNT ) + ' MPH');
                parent.document.getElementById("dvSpeed").innerHTML = 'Speed: ' +Math.round( GAS_COUNT ) + ' MPH';
            }
            
             
            var me = {
                changed: false,
                heading: {{start_heading}},
                lat: {{start_lat}},
                lon: {{start_lon}},
                sess: "{{ session }}",
                move: function(x, y, h) {
                    lat: x;
                    lon: y;
                    heading: h;
                	
                },
                strafe: function(direction) {
                    if (direction == "right") {
                        alert("right");
                    } else if (direction == "left") {
                        alert("left");
                    }
                }
            }

            function server_update() {
                if (me.changed) {
                    timer_active = 0;
                    inactive_timer = 0;
                    me.changed = false;
                    $.getJSON("/update",
                    		{
		                        lat: me.lat,
		                        lon: me.lon,
		                        heading: me.heading,
		                        session: me.sess
		                    },
                    		  function(data) {
		                    	$.each(data.users, function(i,item){
		                            //alert(item.lat);
		                            });
		                    	me.changed = false;
		                    	setTimeout(server_update, 250);
                    		  });
                }else{                	
                	setTimeout(server_update, 250);
                }
                
            }

            function initCallback(object) {
                ge = object;
                ge.getWindow().setVisibility(true);

                ge.getLayerRoot().enableLayerById(ge.LAYER_BUILDINGS, true);
                ge.getOptions().setMouseNavigationEnabled(true);



                var initCam = ge.getView().copyAsCamera(ge.ALTITUDE_RELATIVE_TO_GROUND);
                initCam.setAltitude(ANIM_ALTITUDE);
                initCam.setLatitude(me.lat);
                initCam.setLongitude(me.lon);
                initCam.setHeading(me.heading);

                initCam.setTilt(80);
                initCam.setRoll(0);

                ge.getView().setAbstractView(initCam);
                
                createPlayer('1', 40.759, -73.9849, 'http://www.ricardocunha.com/car.dae');
            }

            function startAnimation() {
                if (!animRunning) {
                    ge.getOptions().setFlyToSpeed(ge.SPEED_TELEPORT);
                    animRunning = true;
                    google.earth.addEventListener(ge, 'frameend', tickAnimation);

                    // start it off
                    tickAnimation();
                }
            }

            function stopAnimation() {
                if (animRunning) {
                    google.earth.removeEventListener(ge, 'frameend', tickAnimation);
                    animRunning = false;
                }
            }

            function tickAnimation() {
                // an example of some camera manipulation that's possible w/ the Earth API
                var camera = ge.getView().copyAsCamera(ge.ALTITUDE_RELATIVE_TO_GROUND);
                var dist;
                
                if (bSpaceKeyDown)
                {
                	dist = TURBO_SPEED;
                }
                else
                { 
                	dist = WALK_SPEED;
                } 

                if (bRightKeyDown) {
                    if (bDownKeyDown) {
                        me.heading = me.heading - TURN_DEGREES;
                    }
                    else {
                        me.heading = me.heading + TURN_DEGREES;
                    }


                    if (!bDownKeyDown && !bUpKeyDown) {
                        dist = 0;
                    }
                }

                if (bLeftKeyDown) {
                    if (bDownKeyDown) {
                        me.heading = me.heading + TURN_DEGREES;
                    }
                    else {
                        me.heading = me.heading - TURN_DEGREES;
                    }

                    if (!bDownKeyDown && !bUpKeyDown) {
                        dist = 0;
                    }
                }

                GAS_COUNT = GAS_COUNT+1;
                if (bDownKeyDown) {
                    dist = 0 - dist;
                    GAS_COUNT = GAS_COUNT+3;
                }
                
           		var dest = destination(me.lat, me.lon, dist, me.heading);
                moveModel(dest[0] , dest[1], 0);
                updateSpeed();
                
                me.lat = dest[0];
                me.lon = dest[1];
                me.changed = true;
                var myLatlng = new google.maps.LatLng(me.lat, me.lon);
                marker.setPosition(myLatlng);
                map.setCenter(myLatlng);

                dest = destination(me.lat, me.lon, dist-20, me.heading);
                
                camera.setAltitude(ANIM_ALTITUDE);
                camera.setLatitude(dest[0]);
                camera.setLongitude(dest[1]);
                camera.setHeading(me.heading);

                camera.setTilt(80);
                camera.setRoll(0);



                ge.getView().setAbstractView(camera);
            }

/* Helper functions, courtesy of
   http://www.movable-type.co.uk/scripts/latlong.html */

            function distance(lat1, lng1, lat2, lng2) {
                var a = Math.sin(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180);
                var b = Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos((lng2 - lng1) * Math.PI / 180);
                return 6371000 * Math.acos(a + b);
            }

            function fix360(angle) {
                return Math.abs(angle%360);

            }


            function destination(lat, lng, dist, heading) {
                lat *= Math.PI / 180;
                lng *= Math.PI / 180;
                heading *= Math.PI / 180;
                dist /= 6371000; // angular dist
                var lat2 = Math.asin(Math.sin(lat) * Math.cos(dist) + Math.cos(lat) * Math.sin(dist) * Math.cos(heading));

                return [
                180 / Math.PI * lat2, 180 / Math.PI * (lng + Math.atan2(Math.sin(heading) * Math.sin(dist) * Math.cos(lat2), Math.cos(dist) - Math.sin(lat) * Math.sin(lat2)))];
            }

            function foo(event, state) {
                if (event.keyCode == '87' || event.keyCode == '38') { //UP & W
                    bUpKeyDown = state;
                    if (state) {
                        startAnimation();
                    }
                    else {
                        if (!bRightKeyDown && !bLeftKeyDown) {
                           // stopAnimation();
                            //GAS_COUNT = 0;
                            updateSpeed();
                        }
                    };
                } else if (event.keyCode == '68' || event.keyCode == '39') { //RIGHT & D
                    bRightKeyDown = state;
                    if (state) {
                        startAnimation();
                    }
                    else {
                        if (!bDownKeyDown && !bUpKeyDown) {
                            stopAnimation();
                        }
                    };

                } else if (event.keyCode == '83' || event.keyCode == '40') { //DOWN & S
                    bDownKeyDown = state;
                    if (state) {
                        startAnimation();
                    }
                    else {
                        if (!bRightKeyDown && !bLeftKeyDown) {
                            //stopAnimation();
                            //GAS_COUNT = 0;
                            updateSpeed();
                        }
                    };
                } else if (event.keyCode == '65' || event.keyCode == '37') { //Left & A
                    bLeftKeyDown = state;
                    if (state) {
                        startAnimation();
                    }
                    else {
                        if (!bDownKeyDown && !bUpKeyDown) {
                            //stopAnimation();
                        }
                    };
                }
                else if (event.keyCode == '32') { //Space
                    bSpaceKeyDown = state;
                    
                }
            }
            
            
           function createPlayer(id, latitude, longitude, dae) {
            // Create a 3D model, initialize it from a Collada file, and place it
            // in the world.

            var placemark = ge.createPlacemark('');
            placemark.setName(id);
            model = ge.createModel('');
            ge.getFeatures().appendChild(placemark);
            var loc = ge.createLocation('');
            model.setLocation(loc);
            var link = ge.createLink('');

            //set scale of model
            var scale = model.getScale();
            scale.setX(0.5);
            scale.setY(0.5);
            scale.setZ(0.5);
            model.setScale(scale)

            // A textured model created in Sketchup and exported as Collada.
            link.setHref(dae);
            model.setLink(link);

            //orientation
            var ori = ge.createOrientation('');
            ori.setRoll(0);
            ori.setHeading(fix360(me.heading+270));
            ori.setTilt(0);
            model.setOrientation(ori);

            loc.setLatitude(latitude);
            loc.setLongitude(longitude);
            placemark.setGeometry(model);
        }
        
      function moveModel(temp1, temp2, alt) {
            var loc = ge.createLocation('');
            loc.setLatLngAlt(temp1, temp2, alt)
            
            //orientation
            var ori = ge.createOrientation('');
            ori.setRoll(0);
            ori.setHeading(fix360(me.heading+270));
            ori.setTilt(0);
            model.setOrientation(ori);
            
            model.setLocation(loc);
        }
         
            $(document).ready(function() {
            	var myLatlng = new google.maps.LatLng(me.lat, me.lon);
            	var myOptions = {
            	  zoom: 15,
            	  center: myLatlng,
            	  disableDefaultUI: true,
            	  mapTypeId: google.maps.MapTypeId.ROADMAP
            	};
            	map = new google.maps.Map(parent.document.getElementById("map_canvas"), myOptions);
            	
            	marker = new google.maps.Marker({
            	      position: myLatlng, 
            	      map: map
            	  });
                google.earth.createInstance("map3d", initCallback, failureCallback);
 
                setTimeout(server_update,250);
                $(document).keydown(function(event) {
                    foo(event, true);
                });
                $(document).keyup(function(event) {
                    foo(event, false);
                });
            });
        </script>
    </head>
    
    <body style="height: 100%; width: 100%;">
        <div id='map3d' style='z-index: 1; border: 1px solid silver; height: 80%; width: 80%;
        position: relative;'>
        </div>       
        
        
<div style="clear: both;"></div>
<script type="text/javascript"><!--
google_ad_client = "pub-3769436149950666";
/* GMT2 */
google_ad_slot = "6186131381";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
    </body>
 

</html>